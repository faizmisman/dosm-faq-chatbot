name: CI & Deploy (Dev)

on:
  push:
    branches: [ main ]
  workflow_dispatch:

permissions:
  id-token: write
  contents: read

jobs:
  build-test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      - name: Run tests
        run: pytest -q
      - name: Archive eval queries artifact
        uses: actions/upload-artifact@v4
        with:
          name: eval-queries
          path: eval/queries.jsonl

  deploy-dev:
    needs: build-test
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Azure login (OIDC)
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
      - name: ACR login
        run: az acr login --name ${{ secrets.ACR_NAME }}
      - name: Compute image tag
        id: meta
        run: echo "IMAGE_TAG=${GITHUB_SHA::7}" >> $GITHUB_OUTPUT
      - name: Build & push image
        run: |
          IMAGE_TAG=${{ steps.meta.outputs.IMAGE_TAG }}
          docker build -t ${{ secrets.ACR_NAME }}.azurecr.io/dosm-faq-chatbot:$IMAGE_TAG .
          docker push ${{ secrets.ACR_NAME }}.azurecr.io/dosm-faq-chatbot:$IMAGE_TAG
      - name: Set AKS context
        uses: azure/aks-set-context@v3
        with:
          resource-group: ${{ secrets.AKS_RG_DEV }}
          cluster-name: ${{ secrets.AKS_NAME_DEV }}
      - name: Install Helm
        uses: azure/setup-helm@v4
      - name: Helm upgrade (dev)
        run: |
          IMAGE_TAG=${{ steps.meta.outputs.IMAGE_TAG }}
          helm upgrade --install faq-chatbot-dev ./deploy/helm \
            --namespace dosm-dev \
            -f deploy/helm/values-dev.yaml \
            --set image.repository=${{ secrets.ACR_NAME }}.azurecr.io/dosm-faq-chatbot \
            --set image.tag=$IMAGE_TAG \
            --set env.MODEL_VERSION=dosm-rag-$IMAGE_TAG \
            --wait --timeout 5m
      - name: Smoke test /health
        run: |
          kubectl run curl-pod --image=curlimages/curl:8.7.1 -i --rm --restart=Never --namespace=dosm-dev -- curl -s http://faq-chatbot-dosm-insights:8000/health || true

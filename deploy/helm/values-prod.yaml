image:
  repository: dosmfaqchatbotacr1lw5a.azurecr.io/dosm-faq-chatbot
  tag: prod
  pullSecretName: ""  # set to acr-pull or managed identity not needed

replicaCount: 3

resources:
  requests:
    cpu: 200m
    memory: 512Mi
  limits:
    cpu: 1500m
    memory: 2Gi

env:
  LOG_LEVEL: INFO
  # API_KEY and DATABASE_URL provided via secrets when enabled
  MODEL_VERSION: "dosm-rag-prod"
  API_KEY_SECRET: prod-api-key
  API_KEY_KEY: PROD_API_KEY
  DB:
    URL_SECRET: prod-db-url
    URL_KEY: DATABASE_URL
nameOverride: "faq-chatbot-dosm-insights"
fullnameOverride: "faq-chatbot-dosm-insights"
keyVaultCSI:
  enabled: false
  tenantId: "00000000-0000-0000-0000-000000000000" # prod tenant ID placeholder
  vaultName: "dosm-kv-prod" # prod Key Vault name placeholder
  objects: |
    array:
      - objectName: api-key
        objectType: secret
        objectVersion: ""
      - objectName: database-url
        objectType: secret
  secretFiles:
    API_KEY: /mnt/secrets-store/api-key
    DATABASE_URL: /mnt/secrets-store/database-url

prometheus:
  scrape: true
  port: 8000
  path: /metrics

secrets:
  enabled: false  # Using external secrets (prod-api-key, prod-db-url)
  apiKey: ""
  databaseUrl: ""

ingress:
  enabled: true
  className: nginx
  host: dosm-faq-prod.57.158.128.224.nip.io  # nip.io provides wildcard DNS for IP addresses

service:
  port: 80
  targetPort: 8000

# RAG ingestion Job configuration (disabled by default)
ragIngest:
  enabled: false
  image:
    repository: dosmfaqchatbotacr1lw5a.azurecr.io/dosm-faq-chatbot
    tag: prod
  model: "sentence-transformers/all-MiniLM-L6-v2"
  chunkSize: 25
  dataset:
    inline: |
      year,indicator,value,notes
      2022,CPI,118.4,Consumer Price Index base 2015=100
    fileName: dataset.csv
    pvcName: ""
    mountPath: /ingest
  backoffLimit: 1
  restartPolicy: Never

# Scheduled RAG ingestion (CronJob) configuration
ragIngestCron:
  enabled: false  # Disabled in prod - use Airflow DAG instead
  schedule: "0 3 * * *"
  image:
    repository: dosmfaqchatbotacr1lw5a.azurecr.io/dosm-faq-chatbot
    tag: prod
  model: "sentence-transformers/all-MiniLM-L6-v2"
  chunkSize: 25
  datasetUrl: "https://storage.dosm.gov.my/labour/lfs_month_duration.csv"
  backoffLimit: 1
  restartPolicy: Never
  resources:
    requests:
      cpu: 250m
      memory: 512Mi
    limits:
      cpu: 1000m
      memory: 1Gi

# Flagger canary deployment configuration
canary:
  enabled: true
  analysis:
    interval: 1m          # How often to check metrics
    threshold: 5          # Max failed checks before rollback
    maxWeight: 50         # Max traffic % to canary (then promote)
    stepWeight: 10        # Traffic increment per successful check (10% -> 20% -> 30%...)
  metrics:
    successRate:
      min: 95             # Minimum 95% success rate (5% error threshold)
    latency:
      max: 1500           # Maximum 1500ms P95 latency
  webhooks: []            # Add Slack/Teams webhooks for notifications

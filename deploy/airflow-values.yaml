# Airflow Helm Chart Configuration for RAG Pipeline
# Lightweight setup for dev cluster (Standard_D2s_v3: 8GB RAM)

# Executor: Use LocalExecutor (simpler than CeleryExecutor, no Redis needed)
executor: "LocalExecutor"

# PostgreSQL backend (reuse existing pg-dosm server)
postgresql:
  enabled: false  # Use external PostgreSQL

# External database configuration
data:
  metadataConnection:
    user: dosm_admin
    pass: "Kusanagi@2105"
    protocol: postgresql
    host: pg-dosm.postgres.database.azure.com
    port: 5432
    db: airflow_metadata
    sslmode: require

# Disable init container migration wait (we run migrations separately)
airflowPodAnnotations:
  cluster-autoscaler.kubernetes.io/safe-to-evict: "true"

# Increase migration check timeout
config:
  core:
    dags_folder: /opt/airflow/dags
    load_examples: false
  webserver:
    expose_config: true
    authenticate: false  # Simplify for dev; use OAuth/LDAP in prod
  scheduler:
    dag_dir_list_interval: 30  # Scan for new DAGs every 30s
  database:
    check_migrations_wait_timeout: 120  # Increase timeout to 120s

# Resource limits (optimize for 8GB dev cluster)
scheduler:
  replicas: 1
  resources:
    requests:
      cpu: 250m
      memory: 512Mi
    limits:
      cpu: 500m
      memory: 1Gi

webserver:
  replicas: 1
  service:
    type: LoadBalancer  # Expose UI externally
  resources:
    requests:
      cpu: 250m
      memory: 512Mi
    limits:
      cpu: 500m
      memory: 1Gi

# Git-sync for DAGs (sync from your repo)
dags:
  gitSync:
    enabled: false  # Disabled for now, will copy DAGs manually
  persistence:
    enabled: true
    size: 1Gi
    storageClassName: ""  # Use default storage class

# Environment variables for DAG access to services
env:
  - name: AIRFLOW__CORE__DAGS_FOLDER
    value: "/opt/airflow/dags"
  - name: PYTHONPATH
    value: "/opt/airflow/dags:/opt/airflow/dags/repo"
  - name: MLFLOW_TRACKING_URI
    value: "http://mlflow.mlflow.svc.cluster.local:5000"

# Extra pip packages for DAGs
extraPipPackages:
  - "apache-airflow-providers-postgres==5.12.0"
  - "sentence-transformers==2.2.2"
  - "pandas==2.0.3"
  - "psycopg2-binary==2.9.9"
  - "mlflow==2.9.2"

# Service accounts
serviceAccount:
  create: true
  name: airflow

# Logs configuration
logs:
  persistence:
    enabled: false  # Use stdout/stderr for dev; consider PVC for prod
